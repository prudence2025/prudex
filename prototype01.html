<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factory X Main Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ## MODIFICATION: Added libraries for advanced chart handling and CSV parsing ## -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <style>
        /* Base styles for the body */
        body {
            font-family: 'Inter', sans-serif;
            color: #333;
            text-align: center;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-image: url("https://prudenceeng.lk/wp-content/uploads/2025/08/download.jpg"); 
            background-size: cover; 
            background-position: center; 
            background-attachment: fixed;
        }
        
        /* Styling for the main heading */
        h1 {
            margin-bottom: 30px;
        }

        /* Header styling */
        header {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-radius: 15px;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            position: relative;
            z-index: 10;
        }
        .header-title {
            font-family: 'Inter', sans-serif;
            font-size: 1.8rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: linear-gradient(to right, #007bff, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            margin-right: 40px;
        }


        .nav-button {
            background-color: #007bff;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .nav-button:hover {
            background-color: #0056b3;
        }
        .dropdown {
            position: relative;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            min-width: 200px;
            box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
            z-index: 20;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
            left: 0;
            top: 100%;
        }
        .dropdown-content.show {
            display: block;
        }
        .dropdown-content a {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }

        /* Glassy effect for the data panels */
        .glass-panel {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        /* ## MODIFICATION: Updated gauge styles for conic-gradient design ## */
        .gauge-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin: 15px;
            min-width: 180px;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            text-align: center;
            flex: 1 1 calc(20% - 30px);
            max-width: calc(20% - 30px);
            box-sizing: border-box;
        }
        .gauge-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 48px 0 rgba(0, 0, 0, 0.15);
        }
        .gauge-container {
            position: relative;
            width: 180px;
            height: 180px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        .gauge-fill {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--fill-color, #e2e8f0) 0deg, #e2e8f0 0deg);
            transition: background 0.5s ease-in-out;
        }
        .gauge-inner-circle {
            position: absolute;
            width: 135px;
            height: 135px;
            border-radius: 50%;
            background-color: rgba(240, 242, 245, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }
        .gauge-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .gauge-label {
            font-size: 1.1em;
            color: #555;
            margin-top: 5px;
            font-weight: 600;
        }
        .gauge-unit {
            font-size: 0.9em;
            color: #777;
            font-weight: normal;
        }

        /* ## MODIFICATION: New gauge color classes ## */
        .gauge-green {
            --fill-color: #10b981 !important;
        }
        .gauge-orange {
            --fill-color: #f97316 !important;
        }

        /* ## MODIFICATION: Updated gauges container for 5 per line layout ## */
        #gauges-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-items: stretch;
            width: 100%;
        }

        /* ## MODIFICATION: Updated device status container for 5 per line layout ## */
        #device-status-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-items: stretch;
            width: 100%;
        }

        /* Device status card styling */
        .device-card {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            text-align: left;
            position: relative;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
            flex: 1 1 calc(20% - 20px);
            max-width: calc(20% - 20px);
            box-sizing: border-box;
            margin: 10px;
        }
        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 48px 0 rgba(0, 0, 0, 0.15);
        }
        .device-name {
            font-size: 1.1em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .value-display {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-top: 5px;
        }
        .disconnected-text {
            font-size: 1.3em;
            font-weight: bold;
            color: #dc2626;
            margin-top: 5px;
        }

        /* Login page styles */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            max-width: 400px;
            width: 90%;
            margin: auto;
            position: relative;
            z-index: 1;
        }
        .login-input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 1.1em;
            background-color: rgba(255, 255, 255, 0.8);
            color: #333;
        }
        .login-button {
            width: 100%;
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1em;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .login-button:hover {
            background-color: #0056b3;
        }
        .login-error {
            color: #dc2626;
            margin-top: 10px;
            font-weight: 600;
        }
        .login-title {
            font-family: 'Inter', sans-serif;
            font-size: 3rem;
            font-weight: 900;
            margin-bottom: 25px;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: linear-gradient(to right, #007bff, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }
        .hidden {
            display: none;
        }

        /* ## MODIFICATION: New modal styles inspired by the provided file ## */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 800px;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }
        .modal-close-button {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #555;
            transition: color 0.2s;
        }
        .modal-close-button:hover {
            color: #000;
        }
        .filter-buttons {
            text-align: center;
            margin-bottom: 1rem;
        }
        .filter-buttons button {
            background-color: #e5e7eb;
            color: #374151;
            padding: 8px 16px;
            margin: 0 5px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .filter-buttons button:hover {
            background-color: #d1d5db;
        }
        .filter-buttons button.active {
            background-color: #007bff;
            color: white;
        }

        /* ## MODIFICATION: Responsive breakpoints for 5-per-line layout ## */
        @media (max-width: 1400px) {
            .gauge-card {
                flex: 1 1 calc(25% - 22.5px);
                max-width: calc(25% - 22.5px);
            }
            .device-card {
                flex: 1 1 calc(25% - 15px);
                max-width: calc(25% - 15px);
            }
        }

        @media (max-width: 1100px) {
            .gauge-card {
                flex: 1 1 calc(33.33% - 20px);
                max-width: calc(33.33% - 20px);
            }
            .device-card {
                flex: 1 1 calc(33.33% - 13.33px);
                max-width: calc(33.33% - 13.33px);
            }
        }

        @media (max-width: 768px) {
            .gauge-card {
                flex: 1 1 calc(50% - 15px);
                max-width: calc(50% - 15px);
            }
            .device-card {
                flex: 1 1 calc(50% - 10px);
                max-width: calc(50% - 10px);
            }
        }

        @media (max-width: 480px) {
            .gauge-card {
                flex: 1 1 100%;
                max-width: 100%;
            }
            .device-card {
                flex: 1 1 100%;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="login-page" class="login-container">
        <h2 class="login-title">PrudeX</h2>
        <input type="text" id="username" placeholder="Username" class="login-input">
        <input type="password" id="password" placeholder="Password" class="login-input">
        <button id="login-button" class="login-button">Login</button>
        <p id="login-error-message" class="login-error hidden"></p>
    </div>

    <div id="dashboard-content" class="hidden flex-grow flex flex-col items-center">
        <header>
            <div class="header-title">Factory X</div>
            <div class="flex space-x-10 items-center">
                <div class="relative dropdown">
                    <button id="dashboard-nav-button" class="nav-button">Dashboard</button>
                    <div id="dashboard-dropdown-content" class="dropdown-content">
                        <a href="#" class="dropdown-item" data-dashboard="main">Factory X Main Dashboard</a>
                        <a href="#" class="dropdown-item" data-dashboard="kandy">Factory X Kandy</a>
                        <a href="#" class="dropdown-item" data-dashboard="galle">Factory X Galle</a>
                    </div>
                </div>
                <div class="relative dropdown">
                    <button id="download-nav-button" class="nav-button">Download</button>
                    <div id="download-dropdown-content" class="dropdown-content">
                        <a href="https://api.prudex.net/download" target="_blank" class="dropdown-item">Factory X Kandy</a>
                        <a href="https://api1.prudex.net/download" target="_blank" class="dropdown-item">Factory X Galle</a>
                    </div>
                </div>
                <button id="logout-button" class="nav-button">Logout</button>
            </div>

        </header>

        <div class="container mx-auto p-4 max-w-7xl mt-16">
            <h1 id="dashboard-main-title" class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500 mb-16">
                 Factory X Main Dashboard
            </h1>

            <div class="glass-panel">
                <div id="device-status-container">
                </div>
            </div>

            <div class="glass-panel">
                <div id="gauges-container">
                </div>
            </div>
        </div>
    </div>

    <!-- ## MODIFICATION: Replaced old modal with new design ## -->
    <div id="history-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title" class="modal-title">Historical Data</h2>
                <button id="modal-close-button" class="modal-close-button">&times;</button>
            </div>
            <div class="modal-body">
                <div class="filter-buttons">
                    <button data-days="1" class="active">1 Day</button>
                    <button data-days="7">7 Days</button>
                    <button data-days="30">30 Days</button>
                </div>
                <canvas id="history-chart"></canvas>
            </div>
        </div>
    </div>
    
    <script>
        const backendUrlMain = "https://api.prudex.net/latest";
        const backendUrlGalle = "https://api1.prudex.net/latest";

        // DOM element references
        const loginPage = document.getElementById("login-page");
        const dashboardContent = document.getElementById("dashboard-content");
        const loginButton = document.getElementById("login-button");
        const logoutButton = document.getElementById("logout-button");
        const usernameInput = document.getElementById("username");
        const passwordInput = document.getElementById("password");
        const loginErrorMessage = document.getElementById("login-error-message");

        const dashboardMainTitle = document.getElementById("dashboard-main-title");
        const deviceStatusContainer = document.getElementById("device-status-container");
        const gaugesContainer = document.getElementById("gauges-container");

        const downloadNavButton = document.getElementById("download-nav-button");
        const downloadDropdownContent = document.getElementById("download-dropdown-content");
        const dashboardNavButton = document.getElementById("dashboard-nav-button");
        const dashboardDropdownContent = document.getElementById("dashboard-dropdown-content");
        const dropdownItems = document.querySelectorAll(".dropdown-item");
        
        // ## MODIFICATION: Updated modal and chart elements ##
        const historyModal = document.getElementById("history-modal");
        const modalCloseButton = document.getElementById('modal-close-button');
        const modalTitle = document.getElementById("modal-title");
        const filterButtons = document.querySelectorAll('.filter-buttons button');
        let historyChart = null;
        let historicalData = []; // To store parsed CSV data

        let currentDashboardView = "main";
        let fetchDataInterval;



        const maxValues = {
            temperature: 50,
            cod: 500,
            bod: 300,
            tss: 300,
            turbidity: 1000,
            ph: 14 
        };

        // ## MODIFICATION: Added warning/danger limits for gauge colors ##
        const parameterInfo = {
            temperature: { id: "temperature", label: "Temperature", unit: "°C", limits: { warning: 30, danger: 35 } },
            cod: { id: "cod", label: "COD", unit: "mg/L", limits: { warning: 100, danger: 250 } },
            bod: { id: "bod", label: "BOD", unit: "mg/L", limits: { warning: 40, danger: 100 } },
            tss: { id: "tss", label: "TSS", unit: "mg/L", limits: { warning: 50, danger: 150 } },
            turbidity: { id: "turbidity", label: "Turbidity", unit: "NTU", limits: { warning: 5, danger: 50 } },
            ph: { id: "ph", label: "pH", unit: "", limits: { warning: 8.5, danger: 9.5 } } // Also checks for low pH
        };
        
        const statusColors = {
            normal: '#38b2ac',
            warning: '#f97316',
            danger: '#ef4444'
        };

        const dashboardParameters = {
            main: ['temperature', 'cod', 'bod', 'tss', 'turbidity', 'ph'],
            kandy: ['temperature', 'cod', 'bod', 'tss', 'turbidity'],
            galle: ['ph']
        };

        /**
         * ## MODIFICATION: New function to determine gauge color status ##
         * Determines the status (normal, warning, danger) based on value and limits.
         */
        function getGaugeStatus(id, value, limits) {
            if (id === 'ph') {
                // pH has both high and low danger/warning zones
                if (value >= limits.danger || value <= (14 - limits.danger)) return 'danger';
                if (value >= limits.warning || value <= (14 - limits.warning)) return 'warning';
                return 'normal';
            }
            if (value >= limits.danger) return 'danger';
            if (value >= limits.warning) return 'warning';
            return 'normal';
        }

        function calculateGaugeFill(value, maxValue) {
            let percentage = (value / maxValue) * 100;
            if (percentage > 100) percentage = 100;
            if (percentage < 0) percentage = 0;
            return (percentage * 3.6);
        }

        /**
         * ## MODIFICATION: Updated gauge creation logic to use new design ##
         */
        function updateOrCreateGaugeCard(id, label, unit, value, limits) {
            let cardElement = document.getElementById(`${id}-gauge-card`);
            const fillAngle = calculateGaugeFill(value, maxValues[id]);
            const displayValue = (typeof value === 'number') ? value.toFixed(2) : '0.00';
            
            // ## MODIFICATION: Apply new color scheme ##
            let gaugeColorClass = '';
            if (id === 'ph') {
                gaugeColorClass = 'gauge-orange';
            } else {
                gaugeColorClass = 'gauge-green';
            }

            if (!cardElement) {
                const cardHtml = `
                    <div id="${id}-gauge-card" class="gauge-card shadow-lg ${gaugeColorClass}">
                        <div class="gauge-container">
                            <div class="gauge-fill" style="background: conic-gradient(var(--fill-color) ${fillAngle}deg, #e2e8f0 ${fillAngle}deg);"></div>
                            <div class="gauge-inner-circle">
                                <span class="gauge-value">${displayValue}</span>
                                <span class="gauge-unit">${unit}</span>
                            </div>
                        </div>
                        <div class="gauge-label text-gray-700">${label}</div>
                    </div>
                `;
                gaugesContainer.insertAdjacentHTML('beforeend', cardHtml);
            } else {
                const gaugeFill = cardElement.querySelector('.gauge-fill');
                const gaugeValueSpan = cardElement.querySelector('.gauge-value');
                
                if (gaugeFill) {
                    gaugeFill.style.background = `conic-gradient(var(--fill-color) ${fillAngle}deg, #e2e8f0 ${fillAngle}deg)`;
                }
                if (gaugeValueSpan) {
                    gaugeValueSpan.textContent = displayValue;
                }
            }
        }

        function updateOrCreateDeviceStatusCard(id, label, value, unit, isConnected) {
            let cardElement = document.getElementById(`${id}-device-card`);
            let contentHtml = (isConnected && typeof value === 'number')
                ? `<div class="value-display">${value.toFixed(2)} ${unit}</div>`
                : `<div class="disconnected-text">Disconnected</div>`;

            if (!cardElement) {
                const cardHtml = `
                    <div id="${id}-device-card" class="device-card" data-parameter="${id}">
                        <div class="device-name">${label} Sensor</div>
                        ${contentHtml}
                    </div>
                `;
                deviceStatusContainer.insertAdjacentHTML('beforeend', cardHtml);
                
                const newCard = document.getElementById(`${id}-device-card`);
                newCard.addEventListener('click', () => {
                    showGraph(id, label);
                });
            } else {
                cardElement.innerHTML = `
                    <div class="device-name">${label} Sensor</div>
                    ${contentHtml}
                `;
            }
        }

        function isDataRecent(timestamp) {
            if (!timestamp) return false;
            const apiTime = new Date(timestamp);
            const currentTime = new Date();
            return (currentTime - apiTime) / 1000 < 15;
        }

        async function fetchData() {
            let latestData = {};
            const dataSourcesStatus = { main: false, galle: false };

            try {
                const fetchPromises = [];
                if (['main', 'kandy'].includes(currentDashboardView)) {
                    fetchPromises.push(fetch(backendUrlMain).then(res => res.json()).then(data => ({ source: 'main', data })));
                }
                if (['main', 'galle'].includes(currentDashboardView)) {
                    fetchPromises.push(fetch(backendUrlGalle).then(res => res.json()).then(data => ({ source: 'galle', data })));
                }

                const results = await Promise.allSettled(fetchPromises);
                results.forEach(result => {
                    if (result.status === 'fulfilled') {
                        const { source, data } = result.value;
                        if (isDataRecent(data.timestamp)) {
                            dataSourcesStatus[source] = true;
                            latestData = { ...latestData, ...data };
                        }
                    }
                });
            } catch (error) {
                console.error("Error fetching data:", error);
            }
            
            deviceStatusContainer.innerHTML = '';
            gaugesContainer.innerHTML = '';

            const paramsToDisplay = dashboardParameters[currentDashboardView] || [];
            const anyDataIsRecent = Object.values(dataSourcesStatus).some(status => status);

            // ## MODIFICATION: Improved handling for disconnected state ##
            if (!anyDataIsRecent && paramsToDisplay.length > 0) {
                // Show individual sensor status instead of general offline message
                paramsToDisplay.forEach(paramId => {
                    const info = parameterInfo[paramId];
                    updateOrCreateDeviceStatusCard(info.id, info.label, 0, info.unit, false);
                    updateOrCreateGaugeCard(info.id, info.label, info.unit, 0, info.limits);
                });
                return;
            }

            paramsToDisplay.forEach(paramId => {
                const info = parameterInfo[paramId];
                const source = (paramId === 'ph') ? 'galle' : 'main';
                const isRecent = dataSourcesStatus[source];
                const value = (isRecent && latestData[info.id] !== undefined) ? parseFloat(latestData[info.id]) : 0;

                updateOrCreateDeviceStatusCard(info.id, info.label, value, info.unit, isRecent);
                updateOrCreateGaugeCard(info.id, info.label, info.unit, isRecent ? value : 0, info.limits);
            });
        }

        /**
         * ## MODIFICATION: New function to fetch and parse all historical data at once ##
         */
        async function fetchAllHistoricalData() {
            try {
                const [kandyResponse, galleResponse] = await Promise.all([
                    fetch("https://api.prudex.net/download"),
                    fetch("https://api1.prudex.net/download")
                ]);
                const kandyText = await kandyResponse.text();
                const galleText = await galleResponse.text();

                const kandyData = Papa.parse(kandyText, { header: true, skipEmptyLines: true }).data;
                const galleData = Papa.parse(galleText, { header: true, skipEmptyLines: true }).data;

                // Combine data, assuming timestamps are the key
                const combinedData = {};
                [...kandyData, ...galleData].forEach(row => {
                    if (row.timestamp) {
                        if (!combinedData[row.timestamp]) {
                            combinedData[row.timestamp] = {};
                        }
                        Object.assign(combinedData[row.timestamp], row);
                    }
                });
                
                historicalData = Object.values(combinedData).map(row => ({
                    ...row,
                    timestamp: new Date(row.timestamp)
                })).sort((a, b) => a.timestamp - b.timestamp);

            } catch (error) {
                console.error("Error fetching historical data:", error);
                historicalData = [];
            }
        }

        /**
         * ## MODIFICATION: New function to show the redesigned graph modal ##
         */
        function showGraph(parameterId, parameterLabel) {
            modalTitle.textContent = `${parameterLabel} - Historical Data`;
            historyModal.dataset.parameter = parameterId;
            updateChart(1); // Default to 1 day view
            historyModal.classList.add('show');
        }

        /**
         * ## MODIFICATION: New function to update the chart with filtered data ##
         */
        function updateChart(days) {
            const parameterId = historyModal.dataset.parameter;
            if (!parameterId || historicalData.length === 0) return;

            const now = new Date();
            const cutoffDate = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));

            const filteredData = historicalData.filter(row => 
                row.timestamp >= cutoffDate && row[parameterId] !== undefined && row[parameterId] !== ''
            );

            if (historyChart) {
                historyChart.destroy();
            }

            const ctx = document.getElementById('history-chart').getContext('2d');
            historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: filteredData.map(row => row.timestamp),
                    datasets: [{
                        label: parameterInfo[parameterId].label,
                        data: filteredData.map(row => parseFloat(row[parameterId])),
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        pointRadius: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'hour', tooltipFormat: 'MMM d, yyyy, h:mm a' },
                            title: { display: true, text: 'Time' }
                        },
                        y: {
                            title: { display: true, text: `Value (${parameterInfo[parameterId].unit})` }
                        }
                    }
                }
            });
            
            filterButtons.forEach(button => {
                button.classList.toggle('active', parseInt(button.dataset.days) === days);
            });
        }


        // --- Login/Logout & Page Setup Logic ---
        function showLoginPage() {
            loginPage.classList.remove("hidden");
            dashboardContent.classList.add("hidden");
            clearInterval(fetchDataInterval);
        }

        function showDashboardPage() {
            loginPage.classList.add("hidden");
            dashboardContent.classList.remove("hidden");
            
            fetchData();
            clearInterval(fetchDataInterval);
            fetchDataInterval = setInterval(fetchData, 5000);
            fetchAllHistoricalData(); // Fetch historical data on login
        }

        loginButton.addEventListener("click", () => {
            if (usernameInput.value === "admin" && passwordInput.value === "2025") {
                loginErrorMessage.classList.add("hidden");
                showDashboardPage();
            } else {
                loginErrorMessage.textContent = "Invalid username or password.";
                loginErrorMessage.classList.remove("hidden");
            }
        });

        logoutButton.addEventListener("click", showLoginPage);

        function setDashboardView(view) {
            currentDashboardView = view;
            const viewTitle = view.charAt(0).toUpperCase() + view.slice(1);
            dashboardMainTitle.textContent = `Factory X ${viewTitle} Dashboard`;
            fetchData();
            dashboardDropdownContent.classList.remove('show');
        }

        dashboardNavButton.addEventListener("click", (e) => {
            e.stopPropagation();
            dashboardDropdownContent.classList.toggle('show');
        });

        downloadNavButton.addEventListener("click", (e) => {
            e.stopPropagation();
            downloadDropdownContent.classList.toggle('show');
        });

        document.addEventListener('click', (e) => {
            if (!dashboardNavButton.contains(e.target)) dashboardDropdownContent.classList.remove('show');
            if (!downloadNavButton.contains(e.target)) downloadDropdownContent.classList.remove('show');
        });

        dropdownItems.forEach(item => {
            if (item.dataset.dashboard) {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    setDashboardView(e.target.dataset.dashboard);
                });
            }
        });

        // --- New Modal Event Listeners ---
        modalCloseButton.addEventListener('click', () => historyModal.classList.remove('show'));
        historyModal.addEventListener('click', (e) => {
            if (e.target === historyModal) historyModal.classList.remove('show');
        });
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                updateChart(parseInt(button.dataset.days));
            });
        });



        showLoginPage();

    </script>
</body>
</html>
