<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factory X Main Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #333;
            text-align: center;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-image: url("https://prudenceeng.lk/wp-content/uploads/2025/08/download.jpg"); 
            background-size: cover; 
            background-position: center; 
            background-attachment: fixed;
        }
        
        h1 {
            margin-bottom: 30px;
        }

        header {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-radius: 15px;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            position: relative;
            z-index: 10;
        }
        .header-title {
            font-family: 'Inter', sans-serif;
            font-size: 1.8rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: linear-gradient(to right, #007bff, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            margin-right: 40px;
        }
        .nav-button {
            background-color: #007bff;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .nav-button:hover {
            background-color: #0056b3;
        }
        .dropdown {
            position: relative;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            min-width: 200px;
            box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
            z-index: 20;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
            left: 0;
            top: 100%;
        }
        .dropdown-content.show {
            display: block;
        }
        .dropdown-content a {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .gauge-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 10px;
            min-width: 180px;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            text-align: center;
        }
        .gauge-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 48px 0 rgba(0, 0, 0, 0.15);
        }

        .gauge-container {
            position: relative;
            width: 180px;
            height: 180px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            background: #e2e8f0; /* Fallback */
        }

        .gauge-fill {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--fill-color) 0deg, #e2e8f0 0deg);
            transition: background 0.5s ease-in-out;
        }

        .gauge-inner-circle {
            position: absolute;
            width: 135px;
            height: 135px;
            border-radius: 50%;
            background-color: rgba(240, 242, 245, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            z-index: 2;
        }

        .gauge-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .gauge-label {
            font-size: 1.1em;
            color: #555;
            margin-top: 5px;
            font-weight: 600;
        }
        .gauge-unit {
            font-size: 0.9em;
            color: #777;
            font-weight: normal;
        }

        .device-card {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            text-align: left;
            position: relative;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 48px 0 rgba(0, 0, 0, 0.15);
        }
        .device-name {
            font-size: 1.1em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .value-display {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-top: 5px;
        }
        .disconnected-text {
            font-size: 1.3em;
            font-weight: bold;
            color: #dc2626;
            margin-top: 5px;
        }

        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            max-width: 400px;
            width: 90%;
            margin: auto;
            position: relative;
            z-index: 1;
        }
        .login-input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 1.1em;
            background-color: rgba(255, 255, 255, 0.8);
            color: #333;
        }
        .login-button {
            width: 100%;
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1em;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .login-button:hover {
            background-color: #0056b3;
        }
        .login-error {
            color: #dc2626;
            margin-top: 10px;
            font-weight: 600;
        }
        .login-title {
            font-family: 'Inter', sans-serif;
            font-size: 3rem;
            font-weight: 900;
            margin-bottom: 25px;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: linear-gradient(to right, #007bff, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }
        .hidden {
            display: none;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 800px;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }
        .modal-close-button {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #555;
            transition: color 0.2s;
        }
        .modal-close-button:hover {
            color: #000;
        }
        .filter-buttons button {
            background-color: #e5e7eb;
            color: #374151;
            padding: 8px 16px;
            margin: 0 5px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .filter-buttons button:hover {
            background-color: #d1d5db;
        }
        .filter-buttons button.active {
            background-color: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <div id="login-page" class="login-container">
        <h2 class="login-title">Factory X</h2>
        <input type="text" id="username" placeholder="Username" class="login-input">
        <input type="password" id="password" placeholder="Password" class="login-input">
        <button id="login-button" class="login-button">Login</button>
        <p id="login-error-message" class="login-error hidden"></p>
    </div>

    <div id="dashboard-content" class="hidden flex-grow flex flex-col items-center">
        <header>
            <div class="header-title">Factory X</div>
            <div class="flex space-x-10 items-center">
                <div class="relative dropdown">
                    <button id="dashboard-nav-button" class="nav-button">Dashboard</button>
                    <div id="dashboard-dropdown-content" class="dropdown-content">
                        <a href="#" class="dropdown-item" data-dashboard="main">Factory X Main Dashboard</a>
                        <a href="#" class="dropdown-item" data-dashboard="kandy">Factory X Kandy</a>
                        <a href="#" class="dropdown-item" data-dashboard="galle">Factory X Galle</a>
                    </div>
                </div>
                <button id="download-button" class="nav-button">Download</button>
                <button id="logout-button" class="nav-button">Logout</button>
            </div>
        </header>

        <div class="container mx-auto p-4 max-w-7xl mt-16">
            <h1 id="dashboard-main-title" class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500 mb-16">
                Factory X Main Dashboard
            </h1>

            <div class="glass-panel">
                <div id="device-status-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 justify-center">
                </div>
            </div>

            <div class="glass-panel">
                <div id="gauges-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 justify-center">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Graph Modal -->
    <div id="graph-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title" class="modal-title">Historical Data</h2>
                <button id="modal-close-button" class="modal-close-button">&times;</button>
            </div>
            <div class="modal-body">
                <div class="filter-buttons text-center mb-4">
                    <button data-days="1" class="active">1 Day</button>
                    <button data-days="7">7 Days</button>
                    <button data-days="30">30 Days</button>
                </div>
                <canvas id="historical-chart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // API endpoints
        const backendUrl = "https://api.prudex.net/latest";
        const historyUrl = "https://api.prudex.net/download";

        // DOM element references
        const loginPage = document.getElementById("login-page");
        const dashboardContent = document.getElementById("dashboard-content");
        const loginButton = document.getElementById("login-button");
        const logoutButton = document.getElementById("logout-button");
        const usernameInput = document.getElementById("username");
        const passwordInput = document.getElementById("password");
        const loginErrorMessage = document.getElementById("login-error-message");

        const dashboardMainTitle = document.getElementById("dashboard-main-title");
        const deviceStatusContainer = document.getElementById("device-status-container");
        const gaugesContainer = document.getElementById("gauges-container");

        const downloadButton = document.getElementById("download-button");
        const dashboardNavButton = document.getElementById("dashboard-nav-button");
        const dashboardDropdownContent = document.getElementById("dashboard-dropdown-content");
        const dropdownItems = document.querySelectorAll(".dropdown-item");

        // Modal and chart elements
        const graphModal = document.getElementById('graph-modal');
        const modalCloseButton = document.getElementById('modal-close-button');
        const modalTitle = document.getElementById('modal-title');
        const filterButtons = document.querySelectorAll('.filter-buttons button');
        let historicalChart = null;
        let historicalData = [];

        let currentDashboardView = "main"; // Default view
        let fetchDataInterval; // Variable to store the interval ID

        const maxValues = {
            temperature: 50,
            cod: 500,
            bod: 300,
            tss: 300,
            turbidity: 1000
        };

        const parameterInfo = {
            temperature: { id: "temperature", label: "Temperature", unit: "Â°C", limits: { warning: 30, danger: 35 } },
            cod: { id: "cod", label: "COD", unit: "mg/L", limits: { warning: 100, danger: 250 } },
            bod: { id: "bod", label: "BOD", unit: "mg/L", limits: { warning: 40, danger: 100 } },
            tss: { id: "tss", label: "TSS", unit: "mg/L", limits: { warning: 50, danger: 150 } },
            turbidity: { id: "turbidity", label: "Turbidity", unit: "NTU", limits: { warning: 5, danger: 50 } },
        };

        const statusColors = {
            normal: '#38b2ac',
            warning: '#f97316',
            danger: '#ef4444'
        };

        function getGaugeStatus(value, limits) {
            if (value >= limits.danger) {
                return 'danger';
            } else if (value >= limits.warning) {
                return 'warning';
            } else {
                return 'normal';
            }
        }

        function calculateGaugeFill(value, maxValue) {
            let percentage = (value / maxValue) * 100;
            if (percentage > 100) percentage = 100;
            if (percentage < 0) percentage = 0;
            return (percentage * 3.6); // Convert percentage to degrees
        }

        function updateOrCreateGaugeCard(id, label, unit, value, limits) {
            let cardElement = document.getElementById(`${id}-gauge-card`);
            const fillAngle = calculateGaugeFill(value, maxValues[id]);
            const displayValue = (typeof value === 'number') ? value.toFixed(2) : '0.00';
            const status = getGaugeStatus(value, limits);
            const fillColor = statusColors[status];

            if (!cardElement) {
                const cardHtml = `
                    <div id="${id}-gauge-card" class="gauge-card shadow-lg flex-1 min-w-40 max-w-xs">
                        <div class="gauge-container">
                            <div class="gauge-fill" style="--fill-color: ${fillColor}; background: conic-gradient(${fillColor} ${fillAngle}deg, #e2e8f0 ${fillAngle}deg);"></div>
                            <div class="gauge-inner-circle">
                                <span class="gauge-value">${displayValue}</span>
                                <span class="gauge-unit">${unit}</span>
                            </div>
                        </div>
                        <div class="gauge-label text-gray-700">${label}</div>
                    </div>
                `;
                gaugesContainer.insertAdjacentHTML('beforeend', cardHtml);
            } else {
                const gaugeFill = cardElement.querySelector('.gauge-fill');
                const gaugeValueSpan = cardElement.querySelector('.gauge-value');
                
                if (gaugeFill) {
                    gaugeFill.style.background = `conic-gradient(${fillColor} ${fillAngle}deg, #e2e8f0 ${fillAngle}deg)`;
                }
                if (gaugeValueSpan) {
                    gaugeValueSpan.textContent = displayValue;
                }
            }
        }

        function updateOrCreateDeviceStatusCard(id, label, value, unit, isConnected) {
            let cardElement = document.getElementById(`${id}-device-card`);
            let contentHtml = isConnected && typeof value === 'number'
                ? `<div class="value-display">${value.toFixed(2)} ${unit}</div>`
                : `<div class="disconnected-text">Disconnected</div>`;

            if (!cardElement) {
                const cardHtml = `
                    <div id="${id}-device-card" class="device-card" data-parameter="${id}" data-label="${label}">
                        <div class="device-name">${label} Sensor</div>
                        ${contentHtml}
                    </div>
                `;
                deviceStatusContainer.insertAdjacentHTML('beforeend', cardHtml);
                document.getElementById(`${id}-device-card`).addEventListener('click', () => showGraph(id, label));
            } else {
                cardElement.innerHTML = `
                    <div class="device-name">${label} Sensor</div>
                    ${contentHtml}
                `;
            }
        }

        function isDataRecent(timestamp) {
            if (!timestamp) return false;
            const apiTime = new Date(timestamp);
            const currentTime = new Date();
            const timeDifference = (currentTime - apiTime) / 1000;
            return timeDifference < 15;
        }

        async function fetchData() {
            let latestItem = null;
            let isDataRecentFlag = false;

            if (currentDashboardView === "main") {
                if (deviceStatusContainer.children.length === 0) {
                    deviceStatusContainer.innerHTML = `<p class="col-span-full text-gray-600">Loading device status...</p>`;
                }
                if (gaugesContainer.children.length === 0) {
                    gaugesContainer.innerHTML = `<p class="col-span-full text-gray-600">Loading live readings...</p>`;
                }

                try {
                    const response = await fetch(backendUrl);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch data. Status: ${response.status}`);
                    }
                    latestItem = await response.json();
                    isDataRecentFlag = isDataRecent(latestItem.timestamp);
                } catch (error) {
                    console.error("Error fetching or processing data:", error);
                    isDataRecentFlag = false;
                }
            } else {
                deviceStatusContainer.innerHTML = `<p class="col-span-full text-gray-600">No data available for ${currentDashboardView} dashboard.</p>`;
                gaugesContainer.innerHTML = `<p class="col-span-full text-gray-600">No data available for ${currentDashboardView} dashboard.</p>`;
                return;
            }

            if (deviceStatusContainer.children.length === 1 && deviceStatusContainer.children[0].tagName === 'P') {
                deviceStatusContainer.innerHTML = "";
            }
            if (gaugesContainer.children.length === 1 && gaugesContainer.children[0].tagName === 'P') {
                gaugesContainer.innerHTML = "";
            }

            Object.values(parameterInfo).forEach(info => {
                const value = (isDataRecentFlag && latestItem && latestItem[info.id] !== undefined) 
                    ? parseFloat(latestItem[info.id]) 
                    : 0;
                
                updateOrCreateDeviceStatusCard(info.id, info.label, value, info.unit, isDataRecentFlag);
                updateOrCreateGaugeCard(info.id, info.label, info.unit, isDataRecentFlag ? value : 0, info.limits);
            });

            if (currentDashboardView === "main" && !isDataRecentFlag) {
                if (deviceStatusContainer.children.length === 0) {
                    deviceStatusContainer.innerHTML = `<p class="col-span-full text-red-500">No recent data received. Displaying disconnected status.</p>`;
                }
                if (gaugesContainer.children.length === 0) {
                    gaugesContainer.innerHTML = `<p class="col-span-full text-red-500">No recent data to display. Gauges showing zero values.</p>`;
                }
            }
        }
        
        async function fetchHistoricalData() {
            try {
                const response = await fetch(historyUrl);
                const csvText = await response.text();
                const parsedData = Papa.parse(csvText, { header: true, skipEmptyLines: true });
                historicalData = parsedData.data.map(row => ({
                    ...row,
                    timestamp: new Date(row.timestamp) 
                })).sort((a, b) => a.timestamp - b.timestamp);
            } catch (error) {
                console.error("Error fetching historical data:", error);
                historicalData = [];
            }
        }

        function showGraph(parameterId, parameterLabel) {
            modalTitle.textContent = `${parameterLabel} - Historical Data`;
            graphModal.dataset.parameter = parameterId;
            updateChart(1);
            graphModal.classList.add('show');
        }
        
        function updateChart(days) {
            const parameterId = graphModal.dataset.parameter;
            if (!parameterId || historicalData.length === 0) return;

            const now = new Date();
            const cutoffDate = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));

            const filteredData = historicalData.filter(row => row.timestamp >= cutoffDate && row[parameterId] !== undefined);

            const chartData = {
                labels: filteredData.map(row => row.timestamp),
                datasets: [{
                    label: parameterInfo[parameterId].label,
                    data: filteredData.map(row => parseFloat(row[parameterId])),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 2,
                    pointRadius: 2,
                    tension: 0.1,
                    fill: true
                }]
            };

            if (historicalChart) {
                historicalChart.destroy();
            }

            const ctx = document.getElementById('historical-chart').getContext('2d');
            historicalChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                tooltipFormat: 'MMM d, yyyy, h:mm a'
                            },
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: `Value (${parameterInfo[parameterId].unit})`
                            }
                        }
                    }
                }
            });
            
            filterButtons.forEach(button => {
                button.classList.toggle('active', parseInt(button.dataset.days) === days);
            });
        }

        function showLoginPage() {
            loginPage.classList.remove("hidden");
            dashboardContent.classList.add("hidden");
            clearInterval(fetchDataInterval);
        }

        function showDashboardPage() {
            loginPage.classList.add("hidden");
            dashboardContent.classList.remove("hidden");
            
            fetchData();
            fetchDataInterval = setInterval(fetchData, 5000);
            fetchHistoricalData();
        }

        loginButton.addEventListener("click", () => {
            const username = usernameInput.value;
            const password = passwordInput.value;

            if (username === "admin" && password === "2025") {
                loginErrorMessage.classList.add("hidden");
                showDashboardPage();
            } else {
                loginErrorMessage.textContent = "Invalid username or password.";
                loginErrorMessage.classList.remove("hidden");
            }
        });

        logoutButton.addEventListener("click", () => {
            showLoginPage();
        });

        downloadButton.addEventListener("click", () => {
            window.location.href = historyUrl;
        });
        
        function setDashboardView(view) {
            currentDashboardView = view;
            dashboardMainTitle.textContent = view === "main" 
                ? "Factory X Main Dashboard" 
                : `Factory X ${view.charAt(0).toUpperCase() + view.slice(1)} Dashboard`;
            fetchData();
            dashboardDropdownContent.classList.remove('show');
        }

        dashboardNavButton.addEventListener("click", (e) => {
            e.stopPropagation();
            dashboardDropdownContent.classList.toggle('show');
        });

        document.addEventListener('click', (e) => {
            if (!dashboardNavButton.contains(e.target) && !dashboardDropdownContent.contains(e.target)) {
                dashboardDropdownContent.classList.remove('show');
            }
        });

        dropdownItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                setDashboardView(e.target.dataset.dashboard);
            });
        });

        modalCloseButton.addEventListener('click', () => {
            graphModal.classList.remove('show');
        });

        graphModal.addEventListener('click', (e) => {
            if (e.target === graphModal) {
                graphModal.classList.remove('show');
            }
        });
        
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                const days = parseInt(button.dataset.days);
                updateChart(days);
            });
        });

        showLoginPage();

    </script>
</body>
</html>
